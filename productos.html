<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Inventario | Ferreter√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* MISMA PALETA QUE INDEX */
        :root {
            --bg-main: #142634;
            --bg-card: #223442;
            --text-light: #e2e8f0;
            --text-muted: #8ca3b8;
            --accent-green: #2ed573;
            --accent-cyan: #00cec9;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-light);
        }

        /* HEADER IDENTICO AL INDEX */
        .top-header {
            background-color: #131e27;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--accent-cyan);
            margin-bottom: 20px;
        }

        .logo-box {
            background: var(--accent-cyan);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--accent-cyan);
        }

        /* ESTILO DE TABLA DARK ANALYTICS */
        .table-container {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2d4356;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .table {
            color: var(--text-light);
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #131e27;
            color: var(--accent-cyan);
            border-bottom: 2px solid #2d4356;
            border-top: none;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            border-bottom: 1px solid #2d4356;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 206, 201, 0.05);
        }

        /* BOTONES ESTILIZADOS */
        .btn-kardex {
            background-color: var(--accent-cyan);
            color: #000;
            font-weight: bold;
            border: none;
        }

        .btn-kardex:hover {
            background-color: #00b3b0;
            color: #140808;
        }

        /* MODALES OSCUROS */
        .modal-content {
            background-color: var(--bg-card);
            color: var(--text-light);
            border: 1px solid #2d4356;
        }

        .modal-header {
            border-bottom: 1px solid #2d4356;
        }

        .form-control,
        .form-select {
            background-color: #182631;
            border: 1px solid #2d4356;
            color: white;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #182631;
            color: white;
            border-color: var(--accent-cyan);
            box-shadow: none;
        }
    </style>
</head>

<body>
    <script>if (!localStorage.getItem('accessToken')) window.location.href = 'login.html';</script>

    <div class="top-header">
        <div class="logo-box"><i class="fas fa-boxes"></i></div>
        <h3 class="m-0 fw-bold text-white tracking-wide" style="letter-spacing: 1px;">Inventario <span
                style="font-weight: 300;">Ferreteria</span></h3>
        <div class="nav-links">
            <a href="index.html">Dashboard</a>
            <a href="productos.html" class="active">Inventario</a>
            <a href="#" onclick="cerrarSesion()" class="text-danger"><i class="fas fa-power-off"></i> Salir</a>
        </div>
    </div>

    <div class="container-fluid px-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0" style="color: var(--accent-green);">Inventario Movimiento y Lista</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-kardex btn-sm px-3 shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#modalMovimiento">
                    <i class="fas fa-exchange-alt me-2"></i> Registrar Movimiento
                </button>
                <button class="btn btn-outline-success btn-sm px-3" onclick="exportarExcel()"><i
                        class="fas fa-file-excel me-1"></i> Excel</button>
                <button class="btn btn-outline-danger btn-sm px-3" onclick="exportarPDF()"><i
                        class="fas fa-file-pdf me-1"></i> PDF</button>
                <button class="btn btn-primary btn-sm px-3" data-bs-toggle="modal" data-bs-target="#modalProducto">
                    <i class="fas fa-plus"></i> Nuevo Item
                </button>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6 col-lg-4">
                <div class="input-group shadow-sm">
                    <span class="input-group-text"
                        style="background-color: var(--bg-card); border-color: #2d4356; color: var(--accent-cyan);">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="buscadorInventario" class="form-control"
                        placeholder="Buscar por Nombre, SKU o Categor√≠a..."
                        style="background-color: var(--bg-card); border-color: #2d4356; color: var(--text-light);">
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>PRODUCT ITEM</th>
                            <th>CATEGORY</th>
                            <th>UNIT PRICE</th>
                            <th class="text-center">QTY IN STOCK</th>
                            <th class="text-end">ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-productos">
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">Cargando Base de Datos... <i
                                    class="fas fa-spinner fa-spin"></i></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalProducto" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="color: var(--accent-green);">A√±adir al Cat√°logo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <div class="mb-2"><label class="small text-muted mb-1">Nombre</label><input type="text"
                                class="form-control" id="prodNombre" required></div>
                        <div class="mb-2"><label class="small text-muted mb-1">SKU</label><input type="text"
                                class="form-control" id="prodSku" required></div>
                        <div class="row">
                            <div class="col-6 mb-2"><label class="small text-muted mb-1">Precio</label><input
                                    type="number" class="form-control" id="prodPrecio" required></div>
                            <div class="col-6 mb-2"><label class="small text-muted mb-1">Stock Inicial</label><input
                                    type="number" class="form-control" id="prodStock" required></div>
                        </div>
                        <div class="mb-4"><label class="small text-muted mb-1">Categor√≠a</label><select
                                class="form-select" id="prodCategoria" required></select></div>
                        <button type="submit" class="btn btn-success w-100">Crear Registro</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalMovimiento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="color: var(--accent-cyan);">Transacci√≥n de Inventario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMovimiento">
                        <div class="mb-3">
                            <label class="small text-muted mb-1">Seleccionar Producto</label>
                            <select class="form-select" id="movProducto" required>
                                <option value="">Cargando cat√°logo...</option>
                            </select>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="small text-muted mb-1">Tipo de Operaci√≥n</label>
                                <select class="form-select" id="movTipo" required>
                                    <option value="ENTRADA"> ENTRADA (Compra)</option>
                                    <option value="SALIDA"> SALIDA (Venta)</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted mb-1">Cantidad</label>
                                <input type="number" class="form-control" id="movCantidad" min="1" required>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="small text-muted mb-1">Referencia / Documento</label>
                            <input type="text" class="form-control" id="movMotivo" placeholder="Ej: Factura 001">
                        </div>
                        <button type="submit" class="btn btn-kardex w-100">Procesar Transacci√≥n</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://api-ferreteria-michea.onrender.com/api/';
        let productosGlobal = [];

        document.addEventListener('DOMContentLoaded', () => { cargarDatos(); });

        async function cargarDatos() {
            try {
                const resCat = await fetch(API_URL + 'categorias/');
                const cats = await resCat.json();
                const sel = document.getElementById('prodCategoria');
                sel.innerHTML = '';
                cats.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.nombre}</option>`);

                const resProd = await fetch(API_URL + 'productos/');
                productosGlobal = await resProd.json();

                renderizarTabla(productosGlobal);
                llenarSelectMovimientos(productosGlobal);

            } catch (e) { console.error("Error", e); }
        }

        function renderizarTabla(lista) {
            const tbody = document.getElementById('tabla-productos');
            tbody.innerHTML = '';


            const filtroActivo = localStorage.getItem('filtroInventario');
            let listaFiltrada = lista;

            let alertBox = document.getElementById('alert-filtro');
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'alert-filtro';
                alertBox.className = 'alert alert-danger d-flex justify-content-between align-items-center mb-3 d-none';
                alertBox.innerHTML = `
                    <span><i class="fas fa-filter me-2"></i> Mostrando solo: <strong>Stock Cr√≠tico</strong></span>
                    <button class="btn btn-sm btn-outline-danger" onclick="limpiarFiltro()">Ver Todo el Inventario</button>
                `;
                document.querySelector('.table-container').parentNode.insertBefore(alertBox, document.querySelector('.table-container'));
            }

            if (filtroActivo === 'critico') {
                listaFiltrada = lista.filter(p => p.stock <= 5);
                alertBox.classList.remove('d-none');
            } else {
                alertBox.classList.add('d-none');
            }
            // --------------------------------------------------------

            if (listaFiltrada.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No se encontraron productos con este criterio.</td></tr>';
                return;
            }


            const formatoCLP = new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                maximumFractionDigits: 0 // Sin decimales
            });

            listaFiltrada.forEach(p => {
                const stockColor = p.stock <= 5 ? '#ff4757' : '#2ed573';
                const row = `
                    <tr>
                        <td><span class="badge" style="background-color: #2d4356; color: #fff">${p.sku}</span></td>
                        <td class="fw-bold" style="color: #000;">${p.nombre}</td>
                        <td><small style="color: #2c3e50">${p.categoria_nombre || 'General'}</small></td>
                        <td class="fw-bold" style="color: #000000;">${formatoCLP.format(p.precio)}</td>
                        <td class="text-center fw-bold" style="color: ${stockColor}; font-size: 1.1rem;">${p.stock}</td>
                        <td class="text-end">
                            <button class="btn btn-sm" style="color: #ff4757; border: 1px solid #ff4757;" onclick="borrar(${p.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }


        window.limpiarFiltro = function () {
            localStorage.removeItem('filtroInventario');
            cargarDatos();
        }

        function llenarSelectMovimientos(lista) {
            const sel = document.getElementById('movProducto');
            sel.innerHTML = '<option value="">Buscar producto...</option>';
            lista.forEach(p => {
                sel.innerHTML += `<option value="${p.id}">${p.sku} - ${p.nombre} (Stock: ${p.stock})</option>`;
            });
        }



        // --- L√ìGICA DEL KARDEX CON VALIDACI√ìN DE STOCK ESTRICTA ---
        document.getElementById('formMovimiento').onsubmit = async (e) => {
            e.preventDefault();

            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerText = 'Procesando...';
            btn.disabled = true;

            const productoId = document.getElementById('movProducto').value;
            const tipo = document.getElementById('movTipo').value;
            const cantidad = parseInt(document.getElementById('movCantidad').value);
            const motivo = document.getElementById('movMotivo').value;
            const usuario = localStorage.getItem('username') || 'Admin';

            // üõ°Ô∏è VALIDACI√ìN ESTRICTA DE QUIEBRE DE STOCK
            const productoSeleccionado = productosGlobal.find(p => p.id == productoId);

            if (tipo === 'SALIDA' && productoSeleccionado) {
                const stockActual = parseInt(productoSeleccionado.stock);
                if (cantidad > stockActual) {
                    Swal.fire({
                        title: '¬°Stock Insuficiente!',
                        html: `Intentas retirar <b>${cantidad}</b> unidades, pero solo hay <b>${stockActual}</b> disponibles.`,
                        icon: 'error',
                        background: '#223442',
                        color: '#ff4757',
                        confirmButtonColor: '#2d4356'
                    });
                    btn.innerText = 'Procesar Transacci√≥n';
                    btn.disabled = false;
                    return; // üõë DETIENE TODO, NO ENV√çA AL BACKEND
                }
            }

            const movimiento = { producto: productoId, tipo, cantidad, motivo, usuario };

            try {
                const res = await fetch(API_URL + 'movimientos/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(movimiento)
                });

                if (res.ok) {
                    Swal.fire({ title: '¬°√âxito!', text: 'Kardex actualizado.', icon: 'success', background: '#223442', color: '#fff' });
                    document.getElementById('formMovimiento').reset();
                    bootstrap.Modal.getInstance(document.getElementById('modalMovimiento')).hide();
                    cargarDatos(); // Recarga la tabla para reflejar el nuevo stock
                } else {
                    Swal.fire('Error', 'Fallo al guardar en el servidor', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'No hay conexi√≥n con la API', 'error');
            } finally {
                btn.innerText = 'Procesar Transacci√≥n';
                btn.disabled = false;
            }
        };



        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(productosGlobal);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, "Data_Export.xlsx");
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Reporte Data Analytics - Ferreteria Michea", 14, 20);
            const tableRows = [];
            productosGlobal.forEach(p => tableRows.push([p.sku, p.nombre, `$${p.precio}`, p.stock]));
            doc.autoTable({ head: [["SKU", "Item", "Price", "Stock"]], body: tableRows, startY: 30 });
            doc.save("Reporte_PDF.pdf");
        }

        async function borrar(id) {
            if (confirm("¬øEliminar item del cat√°logo?")) {
                await fetch(API_URL + `productos/${id}/`, { method: 'DELETE' });
                cargarDatos();
            }
        }

        function cerrarSesion() { localStorage.clear(); window.location.href = 'login.html'; }

        document.getElementById('buscadorInventario').addEventListener('input', (e) => {
            const textoBuscado = e.target.value.toLowerCase();


            const productosFiltrados = productosGlobal.filter(p => {
                const nombre = p.nombre.toLowerCase();
                const sku = p.sku.toLowerCase();
                const categoria = (p.categoria_nombre || 'General').toLowerCase();


                return nombre.includes(textoBuscado) || sku.includes(textoBuscado) || categoria.includes(textoBuscado);
            });


            renderizarTabla(productosFiltrados);
        });
    </script>
</body>

</html>